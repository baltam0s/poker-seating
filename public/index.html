<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poker Seating Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }

    @media (min-width: 768px) {
      body {
        padding: 20px;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      position: relative;
      padding-top: 60px;
    }

    @media (min-width: 768px) {
      .header {
        padding-top: 50px;
      }
    }

    .header h1 {
      font-size: 1.8em;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 0.9em;
      opacity: 0.9;
    }

    @media (min-width: 768px) {
      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1em;
      }
    }

    .admin-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      color: #667eea;
      border: 2px solid #667eea;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .admin-toggle:hover {
      background: #667eea;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    @media (min-width: 768px) {
      .admin-toggle {
        top: 20px;
        left: 20px;
        font-size: 1em;
      }
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    @media (min-width: 1100px) {
      .main-content {
        grid-template-columns: 350px 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      padding: 20px;
    }

    @media (min-width: 768px) {
      .card {
        border-radius: 16px;
        padding: 30px;
      }
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    @media (min-width: 768px) {
      .card h2 {
        margin-bottom: 20px;
        font-size: 1.5em;
      }
    }

    .section {
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .section {
        margin-bottom: 25px;
      }
    }

    .section:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .hint {
      font-size: 0.85em;
      color: #999;
      margin-top: 5px;
    }

    .player-selection {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    @media (min-width: 480px) {
      .player-selection {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .player-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .player-checkbox:hover {
      background: #e9ecef;
    }

    .player-checkbox input[type="checkbox"] {
      margin-right: 8px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .player-checkbox label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
      color: #333;
      flex: 1;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    @media (hover: none) {
      button:hover {
        transform: none;
      }

      button:active {
        opacity: 0.8;
      }
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 10px;
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .error.show {
      display: block;
    }

    .success {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .success.show {
      display: block;
    }

    .loading {
      text-align: center;
      color: #667eea;
      padding: 20px;
      display: none;
    }

    .loading.show {
      display: block;
    }

    /* Poker Table - Rectangular */
    .poker-table-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
      position: relative;
      padding: 10px 0;
    }

    @media (min-width: 768px) {
      .poker-table-container {
        min-height: 500px;
      }
    }

    .poker-table {
      position: relative;
      width: 100%;
      max-width: 700px;
      height: 300px;
    }

    @media (min-width: 768px) {
      .poker-table {
        height: 450px;
      }
    }

    .table-surface {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a5f1a 0%, #2d8b2d 100%);
      border-radius: 60px;
      border: 8px solid #8b4513;
      box-shadow:
        inset 0 0 30px rgba(0, 0, 0, 0.3),
        0 5px 20px rgba(0, 0, 0, 0.4);
      position: relative;
    }

    @media (min-width: 768px) {
      .table-surface {
        border-radius: 100px;
        border: 15px solid #8b4513;
        box-shadow:
          inset 0 0 50px rgba(0, 0, 0, 0.3),
          0 10px 30px rgba(0, 0, 0, 0.4);
      }
    }

    .table-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255, 255, 255, 0.2);
      font-size: 1.5em;
      font-weight: bold;
      user-select: none;
    }

    @media (min-width: 768px) {
      .table-center {
        font-size: 3em;
      }
    }

    .seat {
      position: absolute;
      min-width: 70px;
      padding: 6px 8px;
      background: white;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -50%);
      border: 2px solid #667eea;
      transition: all 0.3s;
    }

    @media (min-width: 768px) {
      .seat {
        min-width: 90px;
        padding: 10px 12px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        border: 3px solid #667eea;
      }
    }

    .seat.eliminated {
      opacity: 0.4;
      border-color: #dc3545;
      background: #f8d7da;
    }

    .seat.eliminated .seat-name {
      text-decoration: line-through;
      color: #999;
    }

    .seat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .seat-number {
      background: #667eea;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.75em;
    }

    @media (min-width: 768px) {
      .seat-number {
        width: 24px;
        height: 24px;
        font-size: 0.85em;
      }
    }

    .eliminate-btn {
      background: #dc3545;
      color: white;
      border: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
    }

    @media (min-width: 768px) {
      .eliminate-btn {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }
    }

    .eliminate-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    .seat-name {
      font-size: 0.75em;
      color: #333;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
      max-width: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (min-width: 768px) {
      .seat-name {
        font-size: 0.9em;
        max-width: 80px;
      }
    }

    .empty-table {
      text-align: center;
      color: #999;
      padding: 40px;
    }

    /* Blind Timer */
    .timer-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
    }

    @media (min-width: 768px) {
      .timer-section {
        padding: 20px;
        margin-bottom: 20px;
      }
    }

    .timer-display {
      font-size: 2em;
      font-weight: bold;
      color: #333;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }

    @media (min-width: 768px) {
      .timer-display {
        font-size: 3em;
        margin: 15px 0;
      }
    }

    .timer-display.warning {
      color: #ffc107;
    }

    .timer-display.danger {
      color: #dc3545;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .timer-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }

    @media (min-width: 768px) {
      .timer-controls {
        gap: 10px;
        margin-top: 15px;
      }
    }

    .timer-btn {
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
      flex: 1;
      min-width: 80px;
    }

    @media (min-width: 480px) {
      .timer-btn {
        padding: 10px 20px;
        flex: 0;
      }
    }

    .blind-level {
      font-size: 1em;
      color: #555;
      margin-top: 8px;
      font-weight: 600;
    }

    @media (min-width: 768px) {
      .blind-level {
        font-size: 1.2em;
        margin-top: 10px;
      }
    }

    /* Winner Selection */
    .winner-section {
      display: none;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-top: 20px;
    }

    .winner-section.show {
      display: block;
    }

    .winner-title {
      color: #333;
      font-size: 1.2em;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .winner-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    @media (min-width: 480px) {
      .winner-buttons {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
    }

    @media (min-width: 768px) {
      .winner-buttons {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    .winner-btn {
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      color: #333;
    }

    .winner-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .winner-btn.eliminated {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Stats Section */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9em;
    }

    @media (min-width: 768px) {
      .stats-table {
        font-size: 1em;
      }
    }

    .stats-table th,
    .stats-table td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    @media (min-width: 768px) {
      .stats-table th,
      .stats-table td {
        padding: 12px;
      }
    }

    .stats-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
    }

    .stats-table tr:hover {
      background: #f8f9fa;
    }

    .win-rate {
      font-weight: 600;
      color: #28a745;
    }

    .history-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      position: relative;
    }

    @media (min-width: 768px) {
      .history-item {
        padding: 15px;
        margin-bottom: 12px;
      }
    }

    .history-date {
      font-size: 0.8em;
      color: #999;
      margin-bottom: 6px;
    }

    @media (min-width: 768px) {
      .history-date {
        font-size: 0.85em;
        margin-bottom: 8px;
      }
    }

    .history-players {
      color: #555;
      font-size: 0.9em;
      margin-bottom: 4px;
    }

    @media (min-width: 768px) {
      .history-players {
        font-size: 0.95em;
        margin-bottom: 5px;
      }
    }

    .history-winner {
      color: #28a745;
      font-weight: 600;
      font-size: 0.9em;
    }

    .history-actions {
      position: relative;
      top: auto;
      right: auto;
      display: flex;
      gap: 5px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    @media (min-width: 768px) {
      .history-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: none;
        margin-top: 0;
      }

      .history-item:hover .history-actions {
        display: flex;
      }
    }

    .action-btn {
      padding: 5px 10px;
      font-size: 12px;
      width: auto;
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 768px) {
      .tabs {
        gap: 10px;
        margin-bottom: 20px;
      }
    }

    .tab {
      padding: 8px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.2s;
      width: auto;
      white-space: nowrap;
      font-size: 0.9em;
    }

    @media (min-width: 768px) {
      .tab {
        padding: 10px 20px;
        font-size: 1em;
      }
    }

    .tab:hover {
      color: #667eea;
      transform: none;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    @media (min-width: 768px) {
      .modal-content {
        border-radius: 16px;
        padding: 30px;
      }
    }

    .modal-title {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
    }

    @media (min-width: 768px) {
      .modal-title {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
    }

    .admin-badge {
      display: inline-block;
      background: #ffc107;
      color: #333;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7em;
      font-weight: bold;
      margin-left: 6px;
      vertical-align: middle;
    }

    @media (min-width: 768px) {
      .admin-badge {
        padding: 3px 8px;
        font-size: 0.75em;
      }
    }

    .empty-table {
      text-align: center;
      color: #999;
      padding: 30px 20px;
      font-size: 0.95em;
    }

    @media (min-width: 768px) {
      .empty-table {
        padding: 40px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé∞ Poker Seating Generator</h1>
      <p>Tournament mode with blind timer and player elimination</p>
      <button class="admin-toggle" onclick="toggleAdminLogin()">
        <span id="adminBtnText">Admin Login</span>
      </button>
    </div>

    <div class="main-content">
      <!-- Left Column: Setup -->
      <div class="card">
        <h2>üéÆ Game Setup</h2>

        <div class="section">
          <label>Select Players</label>
          <div class="player-selection" id="playerSelection"></div>
        </div>

        <div class="section">
          <label for="newPlayer">Add New Player</label>
          <input
            type="text"
            id="newPlayer"
            placeholder="Enter player name"
            autocomplete="off"
          >
          <button class="btn-secondary" onclick="addNewPlayer()">Add Player</button>
        </div>

        <button id="generateBtn" onclick="generateSeating()">
          Generate Seating
        </button>

        <div class="error" id="error"></div>
        <div class="success" id="success"></div>
        <div class="loading" id="loading">Generating seating arrangement...</div>

        <div class="winner-section" id="winnerSection">
          <h3 class="winner-title">üèÜ Select Winner</h3>
          <div class="winner-buttons" id="winnerButtons"></div>
        </div>
      </div>

      <!-- Right Column: Table and Timer -->
      <div>
        <!-- Blind Timer -->
        <div class="card timer-section">
          <h2>‚è±Ô∏è Blind Timer</h2>
          <div class="blind-level" id="blindLevel">Level 1</div>
          <div class="timer-display" id="timerDisplay">45:00</div>
          <div class="timer-controls">
            <button class="timer-btn" onclick="startTimer()">Start</button>
            <button class="timer-btn" onclick="pauseTimer()">Pause</button>
            <button class="timer-btn" onclick="resetTimer()">Reset</button>
          </div>
        </div>

        <!-- Table Visualization -->
        <div class="card">
          <h2>ü™ë Poker Table</h2>
          <div class="poker-table-container" id="tableContainer">
            <div class="empty-table">
              <p>Generate a seating arrangement to see the table</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats and History -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('stats')">üìä Player Stats</button>
        <button class="tab" onclick="switchTab('history')">üìú Game History</button>
      </div>

      <div id="statsTab" class="tab-content active">
        <table class="stats-table" id="statsTable">
          <thead>
            <tr>
              <th>Player</th>
              <th>Games Played</th>
              <th>Wins</th>
              <th>Win Rate</th>
            </tr>
          </thead>
          <tbody id="statsBody">
            <tr>
              <td colspan="4" style="text-align: center; color: #999;">No data yet</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="historyTab" class="tab-content">
        <div id="history">
          <p style="color: #999; font-style: italic;">No games yet</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <h2 class="modal-title">Admin Login</h2>
      <div class="section">
        <label for="adminPassword">Password</label>
        <input type="password" id="adminPassword" placeholder="Enter admin password">
      </div>
      <div class="modal-actions">
        <button onclick="closeAdminModal()">Cancel</button>
        <button onclick="adminLogin()">Login</button>
      </div>
      <div class="error" id="adminError"></div>
    </div>
  </div>

  <script>
    let currentGameId = null;
    let currentSeating = [];
    let eliminatedPlayers = new Set();
    let predefinedPlayers = [
      'Dime', 'Laziƒá', 'Peƒëa', 'ƒêovani', 'Bane', 'Miha', '≈†egi'
    ];
    let isAdmin = false;

    // Timer variables
    let timerInterval = null;
    let timeRemaining = 45 * 60; // 45 minutes in seconds
    let currentLevel = 1;
    const LEVEL_DURATION = 45 * 60; // 45 minutes

    // Load data on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadPredefinedPlayers();
      renderPlayerSelection();
      loadStats();
      loadHistory();
      checkAdminStatus();
      updateTimerDisplay();
    });

    function loadPredefinedPlayers() {
      const saved = localStorage.getItem('pokerPlayers');
      if (saved) {
        predefinedPlayers = JSON.parse(saved);
      }
    }

    function savePredefinedPlayers() {
      localStorage.setItem('pokerPlayers', JSON.stringify(predefinedPlayers));
    }

    function renderPlayerSelection() {
      const container = document.getElementById('playerSelection');
      container.innerHTML = predefinedPlayers.map((player, index) => `
        <div class="player-checkbox">
          <input type="checkbox" id="player-${index}" value="${player}">
          <label for="player-${index}">${player}</label>
        </div>
      `).join('');
    }

    function addNewPlayer() {
      const input = document.getElementById('newPlayer');
      const name = input.value.trim();

      if (!name) {
        showError('Please enter a player name');
        return;
      }

      if (predefinedPlayers.includes(name)) {
        showError('Player already exists');
        return;
      }

      predefinedPlayers.push(name);
      savePredefinedPlayers();
      renderPlayerSelection();
      input.value = '';
      showSuccess('Player added successfully');
    }

    function getSelectedPlayers() {
      const checkboxes = document.querySelectorAll('#playerSelection input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    async function generateSeating() {
      const players = getSelectedPlayers();

      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');
      const generateBtn = document.getElementById('generateBtn');
      const winnerSection = document.getElementById('winnerSection');

      // Reset
      errorDiv.classList.remove('show');
      winnerSection.classList.remove('show');
      errorDiv.textContent = '';
      eliminatedPlayers.clear();

      // Validate
      if (players.length < 2) {
        showError('Please select at least 2 players');
        return;
      }

      // Show loading
      loadingDiv.classList.add('show');
      generateBtn.disabled = true;

      try {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ players })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to generate seating');
        }

        currentGameId = data.gameId;
        currentSeating = data.seating;

        // Display table
        displayPokerTable(data.seating);

        // Show winner selection
        displayWinnerButtons(data.seating);

        // Reset timer
        resetTimer();

      } catch (error) {
        showError(error.message);
      } finally {
        loadingDiv.classList.remove('show');
        generateBtn.disabled = false;
      }
    }

    function displayPokerTable(seating) {
      const container = document.getElementById('tableContainer');
      const numSeats = seating.length;

      // Calculate positions for rectangular table
      const positions = calculateRectangularPositions(numSeats);

      container.innerHTML = `
        <div class="poker-table">
          <div class="table-surface">
            <div class="table-center">‚ô†‚ô•‚ô£‚ô¶</div>
            ${seating.map((player, index) => {
              const pos = positions[index];
              return `
                <div class="seat" id="seat-${index}" style="left: ${pos.x}%; top: ${pos.y}%;">
                  <div class="seat-header">
                    <div class="seat-number">${index + 1}</div>
                    <button class="eliminate-btn" onclick="toggleElimination(${index})" title="Eliminate player">√ó</button>
                  </div>
                  <div class="seat-name">${player}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function calculateRectangularPositions(numSeats) {
      const positions = [];

      // Special case for 7 players: distribute as 2-2-2-1
      if (numSeats === 7) {
        // Top: 2 players
        positions.push({ x: 30, y: 10 });
        positions.push({ x: 70, y: 10 });

        // Right: 2 players
        positions.push({ x: 90, y: 35 });
        positions.push({ x: 90, y: 65 });

        // Bottom: 2 players
        positions.push({ x: 70, y: 90 });
        positions.push({ x: 30, y: 90 });

        // Left: 1 player
        positions.push({ x: 10, y: 50 });

        return positions;
      }

      // For other numbers: max 2 players per side
      // Determine distribution
      let distribution = [];

      if (numSeats <= 2) {
        // 1-2 players: top only
        distribution = [numSeats, 0, 0, 0];
      } else if (numSeats === 3) {
        // 3 players: 2 top, 1 bottom
        distribution = [2, 0, 1, 0];
      } else if (numSeats === 4) {
        // 4 players: 1 on each side
        distribution = [1, 1, 1, 1];
      } else if (numSeats === 5) {
        // 5 players: 2 top, 1 right, 2 bottom
        distribution = [2, 1, 2, 0];
      } else if (numSeats === 6) {
        // 6 players: 2 top, 1 right, 2 bottom, 1 left
        distribution = [2, 1, 2, 1];
      } else {
        // 8+ players: 2 on each side (max 8)
        distribution = [2, 2, 2, 2];
      }

      const [top, right, bottom, left] = distribution;

      // Top side (left to right)
      for (let i = 0; i < top; i++) {
        const x = top === 1 ? 50 : (top === 2 ? [30, 70][i] : 50);
        positions.push({ x, y: 10 });
      }

      // Right side (top to bottom)
      for (let i = 0; i < right; i++) {
        const y = right === 1 ? 50 : (right === 2 ? [35, 65][i] : 50);
        positions.push({ x: 90, y });
      }

      // Bottom side (right to left)
      for (let i = 0; i < bottom; i++) {
        const x = bottom === 1 ? 50 : (bottom === 2 ? [70, 30][i] : 50);
        positions.push({ x, y: 90 });
      }

      // Left side (bottom to top)
      for (let i = 0; i < left; i++) {
        const y = left === 1 ? 50 : (left === 2 ? [65, 35][i] : 50);
        positions.push({ x: 10, y });
      }

      return positions;
    }

    function toggleElimination(seatIndex) {
      const player = currentSeating[seatIndex];
      const seatEl = document.getElementById(`seat-${seatIndex}`);

      if (eliminatedPlayers.has(player)) {
        eliminatedPlayers.delete(player);
        seatEl.classList.remove('eliminated');
      } else {
        eliminatedPlayers.add(player);
        seatEl.classList.add('eliminated');
      }

      // Update winner buttons
      displayWinnerButtons(currentSeating);
    }

    function displayWinnerButtons(seating) {
      const container = document.getElementById('winnerButtons');
      container.innerHTML = seating.map(player => {
        const isEliminated = eliminatedPlayers.has(player);
        return `
          <button
            class="winner-btn ${isEliminated ? 'eliminated' : ''}"
            onclick="selectWinner('${player}')"
            ${isEliminated ? 'disabled' : ''}
          >
            ${player}
          </button>
        `;
      }).join('');

      document.getElementById('winnerSection').classList.add('show');
    }

    async function selectWinner(winner) {
      if (!currentGameId) {
        showError('No active game');
        return;
      }

      if (eliminatedPlayers.has(winner)) {
        showError('Cannot select an eliminated player as winner');
        return;
      }

      try {
        const response = await fetch('/api/winner', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            gameId: currentGameId,
            winner: winner
          })
        });

        if (!response.ok) {
          throw new Error('Failed to record winner');
        }

        // Refresh stats and history
        await loadStats();
        await loadHistory();

        // Hide winner section
        document.getElementById('winnerSection').classList.remove('show');

        // Pause timer
        pauseTimer();

        // Show success message
        showSuccess(`üèÜ ${winner} wins!`);

      } catch (error) {
        showError(error.message);
      }
    }

    // Timer functions
    function startTimer() {
      if (timerInterval) return;

      timerInterval = setInterval(() => {
        timeRemaining--;

        if (timeRemaining <= 0) {
          // Level up
          currentLevel++;
          timeRemaining = LEVEL_DURATION;
          document.getElementById('blindLevel').textContent = `Level ${currentLevel}`;
          playSound();
        }

        updateTimerDisplay();
      }, 1000);
    }

    function pauseTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function resetTimer() {
      pauseTimer();
      currentLevel = 1;
      timeRemaining = LEVEL_DURATION;
      document.getElementById('blindLevel').textContent = `Level ${currentLevel}`;
      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      const timerEl = document.getElementById('timerDisplay');
      timerEl.textContent = display;

      // Color warnings
      timerEl.classList.remove('warning', 'danger');
      if (timeRemaining <= 60) {
        timerEl.classList.add('danger');
      } else if (timeRemaining <= 300) {
        timerEl.classList.add('warning');
      }
    }

    function playSound() {
      // Simple beep using Web Audio API
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }

    // Admin functions
    function toggleAdminLogin() {
      if (isAdmin) {
        if (confirm('Are you sure you want to logout from admin mode?')) {
          logout();
        }
      } else {
        document.getElementById('adminModal').classList.add('show');
      }
    }

    function closeAdminModal() {
      document.getElementById('adminModal').classList.remove('show');
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminError').classList.remove('show');
    }

    async function adminLogin() {
      const password = document.getElementById('adminPassword').value;

      try {
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (!response.ok) {
          document.getElementById('adminError').textContent = data.error || 'Invalid password';
          document.getElementById('adminError').classList.add('show');
          return;
        }

        localStorage.setItem('adminToken', data.token);
        isAdmin = true;
        closeAdminModal();
        updateAdminUI();
        loadHistory(); // Reload to show admin actions
        showSuccess('Admin access granted');

      } catch (error) {
        document.getElementById('adminError').textContent = 'Login failed';
        document.getElementById('adminError').classList.add('show');
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      isAdmin = false;
      updateAdminUI();
      loadHistory();
      showSuccess('Logged out');
    }

    function checkAdminStatus() {
      const token = localStorage.getItem('adminToken');
      if (token) {
        // Verify token with server
        fetch('/api/admin/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(r => r.json())
        .then(data => {
          if (data.valid) {
            isAdmin = true;
            updateAdminUI();
          } else {
            localStorage.removeItem('adminToken');
          }
        })
        .catch(() => {
          localStorage.removeItem('adminToken');
        });
      }
    }

    function updateAdminUI() {
      const btnText = document.getElementById('adminBtnText');
      if (isAdmin) {
        btnText.innerHTML = 'üîì Admin<span class="admin-badge">ACTIVE</span>';
      } else {
        btnText.innerHTML = 'üîê Admin';
      }
    }

    async function deleteGame(gameId) {
      if (!confirm('Are you sure you want to delete this game?')) {
        return;
      }

      const token = localStorage.getItem('adminToken');

      try {
        const response = await fetch(`/api/admin/game/${gameId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Failed to delete game');
        }

        showSuccess('Game deleted successfully');
        await loadStats();
        await loadHistory();

      } catch (error) {
        showError(error.message);
      }
    }

    async function editGame(gameId) {
      const newWinner = prompt('Enter new winner name (or leave empty to remove winner):');

      if (newWinner === null) return; // Cancelled

      const token = localStorage.getItem('adminToken');

      try {
        const response = await fetch(`/api/admin/game/${gameId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ winner: newWinner || null })
        });

        if (!response.ok) {
          throw new Error('Failed to update game');
        }

        showSuccess('Game updated successfully');
        await loadStats();
        await loadHistory();

      } catch (error) {
        showError(error.message);
      }
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const stats = await response.json();

        const tbody = document.getElementById('statsBody');

        if (stats.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No data yet</td></tr>';
          return;
        }

        tbody.innerHTML = stats
          .sort((a, b) => b.winRate - a.winRate)
          .map(stat => `
            <tr>
              <td>${stat.player}</td>
              <td>${stat.gamesPlayed}</td>
              <td>${stat.wins}</td>
              <td class="win-rate">${stat.winRate}%</td>
            </tr>
          `).join('');

      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    async function loadHistory() {
      try {
        const response = await fetch('/api/history');
        const games = await response.json();

        const historyDiv = document.getElementById('history');

        if (games.length === 0) {
          historyDiv.innerHTML = '<p style="color: #999; font-style: italic;">No games yet</p>';
          return;
        }

        historyDiv.innerHTML = games.map(game => {
          const date = new Date(game.created_at).toLocaleString();
          const players = game.players.join(', ');
          const winner = game.winner ? `<div class="history-winner">üèÜ Winner: ${game.winner}</div>` : '<div style="color: #999; font-size: 0.9em;">No winner recorded</div>';

          // Show admin actions if logged in as admin
          const adminActions = isAdmin ? `
            <div class="history-actions">
              <button class="btn-danger action-btn" onclick="editGame(${game.id})">Edit</button>
              <button class="btn-danger action-btn" onclick="deleteGame(${game.id})">Delete</button>
            </div>
          ` : '';

          return `
            <div class="history-item">
              <div class="history-date">${date}</div>
              <div class="history-players"><strong>Players:</strong> ${players}</div>
              ${winner}
              ${adminActions}
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Failed to load history:', error);
        const historyDiv = document.getElementById('history');
        historyDiv.innerHTML = '<p style="color: #dc3545;">Error loading game history. Please try again.</p>';
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success');
      successDiv.textContent = message;
      successDiv.classList.add('show');
      setTimeout(() => successDiv.classList.remove('show'), 3000);
    }

    // Allow Enter key in new player input
    document.getElementById('newPlayer').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addNewPlayer();
      }
    });

    // Allow Enter key in admin password
    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        adminLogin();
      }
    });

    // Close modal when clicking outside
    document.getElementById('adminModal').addEventListener('click', (e) => {
      if (e.target.id === 'adminModal') {
        closeAdminModal();
      }
    });
  </script>
</body>
</html>